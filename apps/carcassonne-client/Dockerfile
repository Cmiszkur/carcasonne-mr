# This file is generated by Nx.
#
# Build the docker image with `npx nx docker-build carcassonne-client`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 4200:4200 -t carcassonne-client`.
FROM docker.io/node:lts-alpine as build

# ENV HOST=0.0.0.0
ENV PORT=443

WORKDIR /usr/local/app

RUN addgroup --system carcassonne-client && \
    adduser --system -G carcassonne-client carcassonne-client

COPY dist/apps/carcassonne-client carcassonne-client
RUN chown -R carcassonne-client:carcassonne-client .

# Stage 2: Serve app with nginx server

# Use official nginx image as the base image
FROM nginx:latest

# Copy the build output to replace the default nginx contents.
COPY apps/carcassonne-client/nginx.conf /etc/nginx/conf.d/default.conf
COPY /etc/ssl/cert.pem /etc/ssl/cert.pem
COPY /etc/ssl/key.pem /etc/ssl/key.pem
COPY /etc/ssl/cloudflare.crt /etc/ssl/cloudflare.crt
COPY --from=build /usr/local/app/carcassonne-client /usr/share/nginx/html

EXPOSE ${PORT}
